# V7.0.7系统完整交易逻辑总结

## 一、核心发现：交易方向与信号名称**相反** ⭐⭐⭐

这是理解整个系统的关键！系统采用**反向交易策略**：

```python
direction_map = {
    'BEARISH_SINGULARITY': 'long',     # 看空信号 → 做多！
    'LOW_OSCILLATION': 'long',         # 低位震荡 → 做多
    'BULLISH_SINGULARITY': 'short',    # 看涨信号 → 做空！
    'HIGH_OSCILLATION': 'short'        # 高位震荡 → 做空
}
```

**为什么这样设计？**
- **BEARISH_SINGULARITY（看空奇点）**：市场看空情绪过度，反而是做多机会（抄底）
- **BULLISH_SINGULARITY（看涨奇点）**：市场看涨情绪过度，反而是做空机会（逃顶）
- **HIGH_OSCILLATION（高位震荡）**：价格在高位震荡，做空等待回调
- **LOW_OSCILLATION（低位震荡）**：价格在低位震荡，做多等待反弹

---

## 二、信号生成系统（FFT + Hilbert变换）

### 计算方法
1. 去趋势价格数据（`scipy.signal.detrend`）
2. FFT滤波（保留前8个频率分量）
3. 希尔伯特变换得到解析信号
4. 提取虚部作为张力，标准化
5. 计算张力的一阶差分作为速度，二阶差分作为加速度

### 5种信号类型

| 信号类型 | 中文名称 | 张力条件 | 加速度条件 | 置信度 |
|---------|---------|---------|-----------|--------|
| **BEARISH_SINGULARITY** | 看空奇点 | T > 0.35 | a < -0.02 | 0.7 |
| **BULLISH_SINGULARITY** | 看涨奇点 | T < -0.35 | a > 0.02 | 0.6 |
| **HIGH_OSCILLATION** | 高位震荡 | T > 0.3 | \|a\| < 0.01 | 0.6 |
| **LOW_OSCILLATION** | 低位震荡 | T < -0.3 | \|a\| < 0.01 | 0.6 |
| **OSCILLATION** | 系统平衡震荡 | \|T\| < 0.5 | \|a\| < 0.02 | 0.8 |

---

## 三、V7.0.5 入场过滤器（详细规则）

### 1. HIGH_OSCILLATION（高位震荡→做空）
**通过条件（必须全部满足）**：
- ✅ 价格相对于EMA ≤ 2% (`price_vs_ema <= 0.02`)
- ✅ 加速度 < 0 (`acceleration < 0`)
- ✅ 量能比率 ≤ 1.1 (`volume_ratio <= 1.1`)

**拒绝条件（任一满足即拒绝）**：
- ❌ `price_vs_ema > 0.02` → "牛市回调(价格>EMA X%)"
- ❌ `acceleration >= 0` → "无向下动能"
- ❌ `volume_ratio > 1.1` → "高位放量"

### 2. LOW_OSCILLATION（低位震荡→做多）
- ✅ **直接通过，无额外过滤条件**

### 3. BULLISH_SINGULARITY（看涨奇点→做空）
**通过条件（必须全部满足）**：
- ✅ 量能比率 ≤ 0.95 (`volume_ratio <= 0.95`)
- ✅ 价格相对于EMA ≤ 5% (`price_vs_ema <= 0.05`)

**拒绝条件**：
- ❌ `volume_ratio > 0.95` → "量能放大"
- ❌ `price_vs_ema > 0.05` → "主升浪(偏离X%)"

### 4. BEARISH_SINGULARITY（看空奇点→做多）
**通过条件**：
- ✅ 价格相对于EMA ≥ -5% (`price_vs_ema >= -0.05`)

**拒绝条件**：
- ❌ `price_vs_ema < -0.05` → "主跌浪(偏离X%)"

### 5. OSCILLATION（系统平衡震荡）
- ❌ **不交易** → "系统平衡震荡，无明显趋势"

---

## 四、出场策略

### 云端系统（不用ZigZag）
- **止盈**：±5%
- **止损**：±2.5%
- **最大持仓时间**：42个4H周期 = 7天

### 本地系统（使用ZigZag）
- 基于转折点动态调整止盈止损
- 需要额外获取1H K线数据
- 逻辑更复杂，但可能获得更好的出场点位

---

## 五、完整交易流程

```
1. 获取BTC 4H K线数据（至少300条）
   ↓
2. 使用FFT+Hilbert计算张力和加速度
   ↓
3. 诊断市场状态（5种信号类型）
   ↓
4. 检查置信度（必须≥0.6）
   ↓
5. V7.0.5过滤器过滤
   ↓
6. 确定交易方向（与信号名称相反）
   ↓
7. 设置止盈止损
   ↓
8. 监控持仓，达到止盈/止损/超时后平仓
```

---

## 六、回测结果验证（2025年6-12月）

根据`backtest_results_2024_2025.csv`：

### 整体表现
- **总交易数**：185笔
- **总盈亏**：+196.63%
- **胜率**：51.89%
- **平均盈亏**：+1.06%

### 分方向表现

| 方向 | 交易数 | 总盈亏 | 胜率 | 平均盈亏 |
|-----|--------|--------|------|----------|
| LONG | 73 | +105.32% | 56.16% | +1.44% |
| SHORT | 112 | +91.31% | 49.11% | +0.82% |

### 关键发现
1. **LONG交易表现更好**：虽然数量少（73 vs 112），但总盈亏和胜率都更高
2. **SHORT交易数量多**：占总交易的60.5%
3. **策略整体有效**：6个月收益+196.63%，月均约+32.8%

---

## 七、与我们总结的5笔交易的对比

### 用户提供的5笔交易（12月-1月）
全部是SHORT方向，这与系统实际逻辑一致：
- 这些SHORT交易对应的信号类型应该是：**BULLISH_SINGULARITY** 或 **HIGH_OSCILLATION**
- 因为系统看到"看涨奇点"或"高位震荡"时，会选择**做空**

### 为什么我们之前的总结是错误的？
我们错误地认为：
- ❌ SHORT信号 = 张力>0.5 = 做空
- ❌ LONG信号 = 张力<-0.5 = 做多

实际情况：
- ✅ SHORT信号 = 张力<-0.35（看涨奇点）或 张力<-0.3（低位震荡）= 做空
- ✅ LONG信号 = 张力>0.35（看空奇点）或 张力>0.3（高位震荡）= 做多

---

## 八、重要参数总结

### 信号计算参数
- **FFT滤波频率数**：8个分量
- **历史数据窗口**：至少60条4H K线
- **置信度阈值**：0.6

### V7.0.5过滤器参数
```python
BULLISH_VOLUME_THRESHOLD = 0.95      # 看涨奇点量能阈值
HIGH_OSC_EMA_THRESHOLD = 0.02        # 高位震荡EMA阈值（2%）
HIGH_OSC_VOLUME_THRESHOLD = 1.1      # 高位震荡量能阈值
BEARISH_EMA_THRESHOLD = -0.05        # 看空奇点EMA阈值（-5%）
```

### 出场参数
```python
FALLBACK_TP = 0.05          # 止盈 +5%
FALLBACK_SL = -0.025        # 止损 -2.5%
MAX_HOLD_PERIODS = 42       # 最大持仓 42个4H周期（7天）
```

### ZigZag参数（本地版本）
```python
ZIGZAG_DEPTH = 12           # ZigZag深度
ZIGZAG_DEVIATION = 5        # ZigZag偏差
```

---

## 九、策略优势与风险

### 优势
1. **反向交易思维**：在市场情绪过度时反向操作，抓住反转机会
2. **多重过滤**：V7.0.5过滤器有效过滤低质量信号
3. **风险可控**：固定止损-2.5%，最大持仓7天
4. **回测验证**：6个月收益+196.63%，策略有效

### 风险
1. **反向交易风险**：市场可能继续朝信号方向运行，导致止损
2. **震荡市表现**：在长期震荡市中可能频繁止损
3. **错过趋势**：反向交易可能在强趋势中过早出场

---

## 十、Excel对比文件说明

生成的`信号对比分析_原始vs总结.xlsx`包含以下Sheet：

1. **原始信号_全部**：所有198条原始信号数据
2. **总结规律_标注点**：我们总结的5笔交易对应的关键时间点标注
3. **V707系统_实际交易**：V7.0.7系统在12月-1月的25笔实际交易
4. **详细对比分析**：逐笔对比我们总结的点位与原始信号
5. **统计总结**：关键发现和统计数据

**注意**：我们总结的5笔交易只是特殊情况，不能代表系统整体逻辑。系统实际有185笔交易（6-12月），逻辑更复杂。

---

*生成时间：2025年*
*数据来源：V7.0.7系统源文件及回测结果*
