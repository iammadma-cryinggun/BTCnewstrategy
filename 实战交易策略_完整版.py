# -*- coding: utf-8 -*-
"""
实战交易策略完整指南
==================
基于710条历史信号的后验最优分析
"""

print("="*140)
print("实战交易策略完整指南")
print("基于710条历史信号的统计分析")
print("="*140)

strategy_guide = """
╔══════════════════════════════════════════════════════════════════════════════════════════════════════╗
║                              BTC 4小时K线 实战交易策略                                               ║
║                                                                                              ║
║  基于历史数据回测验证                                                                         ║
║  - 710条信号分析                                                                              ║
║  - 84笔完整交易                                                                              ║
║  - 做多胜率94.4%，平均盈利+1.98%                                                              ║
║  - 做空胜率68.8%，平均盈利+0.56%                                                              ║
╚══════════════════════════════════════════════════════════════════════════════════════════════════════╝

【目录】
1. 策略核心原理
2. 信号类型识别
3. 做多交易策略
4. 做空交易策略
5. 风险控制规则
6. 实战执行流程
7. 常见问题处理
8. 策略优势与局限

═════════════════════════════════════════════════════════════════════════════════════════════════

【1. 策略核心原理】

┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│ 1.1 核心思想                                                                                   │
│                                                                                              │
│   利用市场奇异点信号，结合局部极值点，在最佳时机入场出场。                                     │
│   基于后验最优路径分析，找出理论上的最佳交易时机。                                             │
│                                                                                              │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│ 1.2 数学基础                                                                                   │
│                                                                                              │
│   局部极值定义（使用scipy.signal.argrelextrema, order=2）:                                     │
│   - 局部高点: P[i] > P[i-2], P[i-1], P[i+1], P[i+2]                                          │
│   - 局部低点: P[i] < P[i-2], P[i-1], P[i+1], P[i+2]                                          │
│                                                                                              │
│   价格vsEMA = (当前价格 - EMA) / EMA × 100%                                                   │
│   - 局部高点平均: 价格vsEMA ≈ +0.63%                                                          │
│   - 局部低点平均: 价格vsEMA ≈ -1.05%                                                          │
│                                                                                              │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│ 1.3 关键参数                                                                                   │
│                                                                                              │
│   参数              |  阈值范围      |  说明                                                  │
│   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━                                      │
│   张力              |  < 0          |  负值表示良好信号，正值表示可能错误                      │
│   量能比率          |  ≥ 1.0        |  高于1.0表示量能充足                                    │
│   价格vsEMA% (做多) |  < -0.5%      |  价格低于EMA适合开多                                   │
│   价格vsEMA% (平多) |  > +0.5%      |  价格高于EMA适合平多                                   │
│   价格vsEMA% (平空) |  < -0.5%      |  价格低于EMA适合平空                                   │
│                                                                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────┘

【2. 信号类型识别】

┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│ 2.1 三大信号类型                                                                               │
│                                                                                              │
│   ┌──────────────────┬──────────────────┬────────────────┬──────────────┐                   │
│   │   信号类型       │   交易方向       │   ACTION率     │   建议策略    │                   │
│   ├──────────────────┼──────────────────┼────────────────┼──────────────┤                   │
│   │ BEARISH_         │   做多          │   27.5%        │   耐心等待    │                   │
│   │ SINGULARITY      │                  │                │   低点入场    │                   │
│   ├──────────────────┼──────────────────┼────────────────┼──────────────┤                   │
│   │ BULLISH_         │   做空          │   43.6%        │   积极进场    │                   │
│   │ SINGULARITY      │                  │                │   信号驱动    │                   │
│   ├──────────────────┼──────────────────┼────────────────┼──────────────┤                   │
│   │ OSCILLATION      │   不交易        │   5.8%         │   观望为主    │                   │
│   └──────────────────┴──────────────────┴────────────────┴──────────────┘                   │
│                                                                                              │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│ 2.2 信号模式映射                                                                               │
│                                                                                              │
│   LONG_MODE  ← BEARISH_SINGULARITY, LOW_OSCILLATION  (做多模式)                               │
│   SHORT_MODE ← BULLISH_SINGULARITY, HIGH_OSCILLATION (做空模式)                               │
│   NO_TRADE  ← OSCILLATION                                   (震荡观望)                       │
│                                                                                              │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│ 2.3 识别错误信号                                                                               │
│                                                                                              │
│   🔴 红旗信号（建议跳过）:                                                                     │
│   - 张力 > 0 (正值)                                                                           │
│   - 量能比率 < 1.0                                                                            │
│   - OSCILLATION信号（94.2%是HOLD）                                                            │
│                                                                                              │
│   🟢 绿旗信号（可以考虑）:                                                                     │
│   - 张力 < 0 (负值) ✓                                                                        │
│   - 量能比率 ≥ 1.0 ✓                                                                         │
│   - BULLISH_SINGULARITY ✓ (最高ACTION率43.6%)                                                 │
│                                                                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────┘

【3. 做多交易策略】 BEARISH_SINGULARITY

┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│ 3.1 策略概述                                                                                   │
│                                                                                              │
│   历史表现: 36笔交易, 胜率94.4%, 平均盈利+1.98%, 平均持仓13.7小时                                │
│   核心特点: 必须等待局部低点入场，不能急躁                                                     │
│                                                                                              │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│ 3.2 入场条件（全部满足才入场）                                                                  │
│                                                                                              │
│   ✅ 步骤1: 等待BEARISH_SINGULARITY信号                                                         │
│   ✅ 步骤2: 确认张力 < 0                                                                        │
│   ✅ 步骤3: 确认量能比率 ≥ 1.0                                                                  │
│   ✅ 步骤4: 等待局部低点（价格vsEMA < -0.5%）                                                    │
│   ✅ 步骤5: 在低点K线收盘价开多                                                                 │
│                                                                                              │
│   注意: 97.2%的开仓都在局部低点，只有2.8%在信号切换时立即入场                                    │
│        历史数据显示，等待低点可以大幅提高胜率                                                    │
│                                                                                              │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│ 3.3 持仓管理                                                                                   │
│                                                                                              │
│   📊 持有期间:                                                                                 │
│   - 如果遇到新的局部低点 → 刷新入场价（平多/开多）                                               │
│   - 其他情况 → 继续持有                                                                        │
│   - 平均持仓3.4根K线（约13.7小时）                                                             │
│                                                                                              │
│   刷新入场价的意义:                                                                             │
│   - 在更低位置重新入场，提高盈利空间                                                           │
│   - 91.7%的交易会通过刷新入场价优化成本                                                         │
│                                                                                              │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│ 3.4 出场条件（满足任一即平仓）                                                                  │
│                                                                                              │
│   ✅ 条件1: 遇到局部高点（价格vsEMA > +0.5%）                                                    │
│   ✅ 条件2: 信号模式切换到SHORT_MODE                                                            │
│   ✅ 条件3: 进入OSCILLATION模式                                                                 │
│                                                                                              │
│   平仓方式: 在高点K线的收盘价平多                                                               │
│   历史数据: 91.7%的平仓在局部高点                                                               │
│                                                                                              │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│ 3.5 实战示例                                                                                   │
│                                                                                              │
│   2025-08-19 20:00 BEARISH_SINGULARITY出现                                                     │
│   ├─ 张力 = 0.78 (>0不满足，但信号刚出现可观察)                                                 │
│   ├─ 量能比率 = 1.21 (≥1.0 ✓)                                                                 │
│   ├─ 2025-08-20 00:00 继续等待（没有局部低点）                                                  │
│   ├─ 2025-08-20 04:00 继续等待                                                                 │
│   ├─ 2025-08-20 12:00 出现局部低点！价格vsEMA = -0.35%                                          │
│   └─ 在112193.71开多 ✓                                                                        │
│                                                                                              │
│   持有期间:                                                                                    │
│   ├─ 2025-08-22 04:00 出现局部高点！价格vsEMA = +2.15%                                         │
│   └─ 在113094.83平多 ✓ (盈利+0.80%)                                                           │
│                                                                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────┘

【4. 做空交易策略】 BULLISH_SINGULARITY

┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│ 4.1 策略概述                                                                                   │
│                                                                                              │
│   历史表现: 48笔交易, 胜率68.8%, 平均盈利+0.56%, 平均持仓19.8小时                                │
│   核心特点: 信号出现立即进场，不要等待高点                                                      │
│                                                                                              │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│ 4.2 入场条件                                                                                   │
│                                                                                              │
│   ✅ 方式1: 信号模式刚切换时（优先）75%的开仓使用此方式                                         │
│      - 检测到BULLISH_SINGULARITY → 立即开空                                                    │
│      - 不要等待局部高点                                                                        │
│                                                                                              │
│   ✅ 方式2: 遇到局部高点时（辅助）25%的开仓使用此方式                                          │
│      - 在SHORT_MODE期间遇到局部高点 → 开空                                                     │
│      - 刷新入场价                                                                              │
│                                                                                              │
│   验证条件:                                                                                    │
│   - 张力 < 0                                                                                   │
│   - 量能比率 ≥ 1.0                                                                            │
│                                                                                              │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│ 4.3 持仓管理                                                                                   │
│                                                                                              │
│   📊 持有期间:                                                                                 │
│   - 如果遇到新的局部高点 → 刷新入场价（平空/开空）                                               │
│   - 其他情况 → 继续持有                                                                        │
│   - 平均持仓5.0根K线（约19.8小时）                                                             │
│                                                                                              │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│ 4.4 出场条件                                                                                   │
│                                                                                              │
│   ✅ 条件1: 遇到局部低点（价格vsEMA < -0.5%）                                                    │
│   ✅ 条件2: 信号模式切换到LONG_MODE                                                             │
│   ✅ 条件3: 进入OSCILLATION模式                                                                 │
│                                                                                              │
│   平仓方式: 在低点K线的收盘价平空                                                               │
│   历史数据: 81.2%的平仓在局部低点                                                              │
│                                                                                              │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│ 4.5 实战示例                                                                                   │
│                                                                                              │
│   2025-08-27 00:00 BULLISH_SINGULARITY出现                                                     │
│   ├─ 张力 = -0.73 (<0 ✓)                                                                      │
│   ├─ 量能比率 = 1.03 (≥1.0 ✓)                                                                 │
│   ├─ 信号刚切换！立即在111418.15开空 ✓                                                         │
│   ├─ 2025-08-27 04:00 局部低点，平空                                                           │
│   └─ 盈利+0.62%                                                                               │
│                                                                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────┘

【5. 风险控制规则】

┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│ 5.1 止损设置                                                                                   │
│                                                                                              │
│   🔴 做多止损:                                                                                 │
│   - 固定止损: 入场价 -2%                                                                       │
│   - 移动止损: 盈利超过+1%后，止损价提高到成本价                                                │
│   - 时间止损: 持仓超过48小时无进展，考虑平仓                                                    │
│                                                                                              │
│   🔴 做空止损:                                                                                 │
│   - 固定止损: 入场价 +2%                                                                       │
│   - 移动止损: 盈利超过+1%后，止损价降低到成本价                                                │
│   - 时间止损: 持仓超过72小时无进展，考虑平仓                                                    │
│                                                                                              │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│ 5.2 仓位管理                                                                                   │
│                                                                                              │
│   💰 推荐仓位:                                                                                 │
│   - 保守型: 每笔交易投入总资金的2-3%                                                           │
│   - 平衡型: 每笔交易投入总资金的3-5%                                                           │
│   - 激进型: 每笔交易投入总资金的5-8%                                                           │
│                                                                                              │
│   ⚠️  禁止事项:                                                                               │
│   - 单笔交易超过总资金的10%                                                                    │
│   - 同时持有超过3个仓位                                                                        │
│   - 在OSCILLATION期间开新仓                                                                   │
│                                                                                              │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│ 5.3 跳过信号的条件                                                                             │
│                                                                                              │
│   ❌ 跳过交易的情况:                                                                           │
│   1. 张力 > 0                                                                                 │
│   2. 量能比率 < 0.8                                                                           │
│   3. 信号类型是OSCILLATION                                                                    │
│   4. 已有3个开放仓位                                                                          │
│   5. 市场出现极端波动（单根K线涨跌超过5%）                                                     │
│   6. 重要新闻事件前夕（美联储会议、CPI数据等）                                                │
│                                                                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────┘

【6. 实战执行流程】

┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│ 6.4 每日检查清单（每4小时执行一次）                                                             │
│                                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────┐            │
│   │  [ ] 检查新信号是否出现                                                      │            │
│   │  [ ] 确认信号类型（BEARISH/BULLISH/OSCILLATION）                              │            │
│   │  [ ] 检查参数是否满足入场条件                                                 │            │
│   │      ├─ 张力 < 0 ?                                                           │            │
│   │      └─ 量能比率 ≥ 1.0 ?                                                     │            │
│   │  [ ] 识别当前是否有局部极值点                                                 │            │
│   │  [ ] 检查现有持仓状态                                                       │            │
│   │  [ ] 根据策略执行交易                                                         │            │
│   │  [ ] 更新交易日志                                                           │            │
│   └─────────────────────────────────────────────────────────────────────────────┘            │
│                                                                                              │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│ 6.2 决策流程图                                                                                 │
│                                                                                              │
│   新信号出现                                                                                   │
│      │                                                                                       │
│      ├─ OSCILLATION → 观望，平掉现有持仓（如果有的话）                                          │
│      │                                                                                       │
│      ├─ BEARISH_SINGULARITY                                                                  │
│      │   │                                                                                    │
│      │   ├─ 张力 ≥ 0 或 量能 < 1.0 → 跳过 ❌                                                 │
│      │   │                                                                                    │
│      │   └─ 满足条件 → 等待局部低点 → 开多 ✅                                                │
│      │                                                                                       │
│      └─ BULLISH_SINGULARITY                                                                  │
│          │                                                                                    │
│          ├─ 张力 ≥ 0 或 量能 < 1.0 → 跳过 ❌                                                 │
│          │                                                                                    │
│          └─ 满足条件 → 立即开空 ✅                                                           │
│                                                                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────┘

【7. 常见问题处理】

┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│ 7.1 Q: 如果等不到局部低点怎么办？                                                               │
│                                                                                              │
│   A: 做多信号下，历史数据显示97.2%的入场在局部低点。如果连续3根K线（12小时）都没有低点，         │
│      可以考虑在当前价格小仓位入场（但这是次优选择）。                                           │
│                                                                                              │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│ 7.2 Q: 信号刚出现就交易，还是等K线收盘？                                                       │
│                                                                                              │
│   A: 等K线收盘！价格在收盘前可能大幅波动，只有收盘价才确认。                                    │
│      做多：等低点K线收盘价开多                                                                 │
│      做空：信号确认后，在当前K线收盘价开空                                                     │
│                                                                                              │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│ 7.3 Q: 可以同时持有多单和空单吗？                                                               │
│                                                                                              │
│   A: 不建议。策略设计是单向持仓，对冲会降低效率。先平掉反向仓位，再开新仓位。                    │
│                                                                                              │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│ 7.4 Q: 如果遇到假突破怎么办？                                                                   │
│                                                                                              │
│   A: 这是止损发挥作用的时候。假突破是正常的，即使94.4%胜率的做多策略也有5.6%的失败率。           │
│      关键是严格执行止损，不要扛单。                                                            │
│                                                                                              │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│ 7.5 Q: OSCILLATION期间完全没有机会吗？                                                          │
│                                                                                              │
│   A: OSCILLATION的ACTION率只有5.8%，94.2%是HOLD。但如果你持有仓位，在极值点应该平仓。            │
│      OSCILLATION期间不建议开新仓。                                                             │
│                                                                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────┘

【8. 策略优势与局限】

┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│ 8.1 策略优势                                                                                   │
│                                                                                              │
│   ✅ 数据驱动: 基于710条真实历史信号的后验最优分析                                              │
│   ✅ 高胜率: 做多胜率94.4%，做空胜率68.8%                                                      │
│   ✅ 规则明确: 入场、出场、止损都有清晰标准                                                     │
│   ✅ 可回测: 所有规则都可以用历史数据验证                                                       │
│   ✅ 风险可控: 固定止损+仓位管理                                                                │
│                                                                                              │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│ 8.2 策略局限                                                                                   │
│                                                                                              │
│   ⚠️  后验偏差: 基于未来数据分析，实际交易可能达不到理想效果                                      │
│   ⚠️  滑点成本: 实际交易有手续费、滑点，会降低收益                                               │
│   ⚠️  信号延迟: 等待K线收盘和极值确认，可能错过最佳时机                                          │
│   ⚠️  黑天鹅事件: 极端市场情况下，局部极值可能失效                                                │
│   ⚠️  样本外表现: 历史表现不代表未来结果                                                        │
│                                                                                              │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│ 8.3 改进方向                                                                                   │
│                                                                                              │
│   🔬 可以进一步研究:                                                                           │
│   - 不同量能比率阈值的影响                                                                     │
│   - 加权多个参数的过滤条件                                                                     │
│   - 动态调整仓位大小                                                                           │
│   - 结合其他技术指标确认                                                                       │
│   - 不同时间周期的表现                                                                         │
│                                                                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────┘

【9. 实战快速参考卡】

┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                              │
│   📊 做多策略 (BEARISH_SINGULARITY)                                                            │
│   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━          │
│   ✅ 入场: 张力<0 AND 量能≥1.0 AND 等待局部低点                                                │
│   ✅ 出场: 遇到局部高点 OR 信号切换                                                             │
│   ✅ 止损: -2%                                                                                 │
│   ✅ 仓位: 2-5%                                                                               │
│   📈 胜率: 94.4%                                                                              │
│   💰 平均盈利: +1.98%                                                                          │
│                                                                                              │
│   📊 做空策略 (BULLISH_SINGULARITY)                                                            │
│   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━          │
│   ✅ 入场: 张力<0 AND 量能≥1.0 AND 信号切换立即进场                                             │
│   ✅ 出场: 遇到局部低点 OR 信号切换                                                             │
│   ✅ 止损: +2%                                                                                 │
│   ✅ 仓位: 2-5%                                                                               │
│   📈 胜率: 68.8%                                                                              │
│   💰 平均盈利: +0.56%                                                                          │
│                                                                                              │
│   🚫 跳过信号: OSCILLATION OR 张力>0 OR 量能<1.0                                               │
│                                                                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────┘

═════════════════════════════════════════════════════════════════════════════════════════════════

【重要提示】

本策略基于历史数据的后验分析，仅供参考。实际交易存在风险，历史表现不保证未来结果。
建议：
1. 先在模拟账户测试
2. 小仓位实盘验证
3. 严格止损
4. 持续记录和优化
5. 根据实际情况调整参数

祝交易顺利！ 📈

═════════════════════════════════════════════════════════════════════════════════════════════════
"""

print(strategy_guide)

# 保存到文件
with open('实战交易策略_完整指南.txt', 'w', encoding='utf-8') as f:
    f.write(strategy_guide)

print("\n" + "="*140)
print("策略指南已保存到: 实战交易策略_完整指南.txt")
print("="*140)
