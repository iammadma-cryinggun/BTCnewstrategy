# 修正后的完整交易逻辑 - 包含数据来源

**版本**: v1.1 Corrected
**修正**: 补充第0层数据来源

---

## 📊 完整的七层决策流程

```
┌─────────────────────────────────────────────────────┐
│  第0层: 数据获取 (数据来源) ← 这是基础！              │
│                                                     │
│  数据源选项:                                         │
│  A. 实时数据: Binance API (https://api.binance.com) │
│     - K线数据 (开高低收)                             │
│     - 成交量                                         │
│     - 24h ticker数据                                 │
│                                                     │
│  B. 历史数据: CSV文件                                │
│     - 带信号标记_完整数据_修复版.csv                │
│     - 或其他K线数据                                  │
│                                                     │
│  获取数据:                                           │
│  - 时间戳 (timestamp)                               │
│  - 开盘价 (open)                                    │
│  - 最高价 (high)                                    │
│  - 最低价 (low)                                     │
│  - 收盘价 (close) ← 主要使用                         │
│  - 成交量 (volume)                                   │
│  - 成交额 (quote_volume)                             │
└─────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│  第1层: 基础指标计算                                │
│                                                     │
│  从原始数据计算:                                     │
│  1. EMA (指数移动平均)                               │
│     EMA = α × 当前价格 + (1-α) × 上期EMA            │
│     α = 2 / (周期+1), 默认周期=20                   │
│                                                     │
│  2. 量能比率                                         │
│     Volume_Ratio = 当前成交量 / 平均成交量(20期)     │
│                                                     │
│  3. 张力 (Tension)                                   │
│     Tension = (当前价格 - EMA) / EMA                │
│     表示价格偏离均线的程度                           │
│                                                     │
│  4. 加速度 (Acceleration)                            │
│     Accel = 本次价格变化率 - 上次价格变化率          │
│     表示动量的变化                                   │
└─────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│  第2层: V8.0突变检测                                │
│                                                     │
│  输入: EMA, 量能比率, 加速度, 张力                   │
│  计算: V8_Score = 加权评分                           │
│    - EMA突变 (50%): |Delta_EMA| / 0.3               │
│    - 量能突变 (30%): |Delta_Vol| / 0.5              │
│    - 基础量能 (20%): Volume_Ratio / 2.0              │
│                                                     │
│  触发: V8_Score >= 0.7                              │
└─────────────────────────────────────────────────────┘
                        ↓ (如果V8_Score >= 0.7)
┌─────────────────────────────────────────────────────┐
│  第3层: Singularity信号分类                         │
│  - BEARISH_SINGULARITY (张力<-0.7 且 加速度<-0.2)    │
│  - BULLISH_SINGULARITY (张力>0.7 且 加速度>0.2)      │
│  - OSCILLATION (震荡)                               │
│  - LOW_OSCILLATION (低位震荡)                       │
└─────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│  第4层: 简化微观结构过滤                            │
│  检测A: 负Gamma陷阱 → SKIP                          │
│  检测B: Vanna挤压 → LONG 150%                       │
│  检测C: 正常市场 → 标准决策                          │
└─────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│  第5层: V8.0反向策略决策                            │
│  BEARISH → 做多                                     │
│  BULLISH → 做空                                     │
│  OSCILLATION → 不交易                                │
└─────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│  第6层: 仓位管理                                    │
│  100% / 150% / 250%                                 │
└─────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│  第7层: 风险管理                                    │
│  止损 -3%, 止盈 +10%                                │
└─────────────────────────────────────────────────────┘
```

---

## 🔍 第0层详细说明：数据获取

### 方案A: 实时数据 (Binance API)

```python
import requests

def get_binance_klines(symbol='BTCUSDT', interval='4h', limit=100):
    """
    从Binance获取K线数据

    参数:
        symbol: 交易对
        interval: 时间周期 (1m, 5m, 15m, 1h, 4h, 1d等)
        limit: 返回数量 (1-1000)

    返回:
        [
            [
                1609459200000,  # K线开盘时间
                "37500.00",    # 开盘价
                "37600.00",    # 最高价
                "37400.00",    # 最低价
                "37550.00",    # 收盘价
                "1234.56",     # 成交量
                1609459259999,  # K线收盘时间
                "46312345.67", # 成交额
                1234,          # 成交笔数
                "567.89",      # 主动买入成交量
                "234.56"       # 主动卖出成交量
            ],
            ...
        ]
    """
    url = f"https://api.binance.com/api/v3/klines"

    params = {
        'symbol': symbol,
        'interval': interval,
        'limit': limit
    }

    response = requests.get(url, params=params)
    data = response.json()

    # 转换为DataFrame
    import pandas as pd

    df = pd.DataFrame(data, columns=[
        'open_time', 'open', 'high', 'low', 'close', 'volume',
        'close_time', 'quote_volume', 'trades',
        'taker_buy_base', 'taker_buy_quote'
    ])

    # 数据类型转换
    df['close'] = df['close'].astype(float)
    df['volume'] = df['volume'].astype(float)
    df['high'] = df['high'].astype(float)
    df['low'] = df['low'].astype(float)
    df['quote_volume'] = df['quote_volume'].astype(float)

    # 时间转换
    df['time'] = pd.to_datetime(df['open_time'], unit='ms')

    return df

# 使用示例
df = get_binance_klines(symbol='BTCUSDT', interval='4h', limit=100)
print(df[['time', 'close', 'volume']].tail())
```

### 方案B: 24hr Ticker数据 (更简单)

```python
def get_binance_ticker(symbol='BTCUSDT'):
    """
    获取24小时ticker数据（最新快照）

    包含:
        - 当前价格
        - 24h涨跌幅
        - 24h最高最低
        - 24h成交量
        等等
    """
    url = f"https://api.binance.com/api/v3/ticker/24hr"

    params = {'symbol': symbol}
    response = requests.get(url, params=params)
    data = response.json()

    return {
        'price': float(data['lastPrice']),
        'change_percent': float(data['priceChangePercent']),
        'high': float(data['highPrice']),
        'low': float(data['lowPrice']),
        'volume': float(data['volume']),
        'quote_volume': float(data['quoteVolume'])
    }

# 使用示例
ticker = get_binance_ticker('BTCUSDT')
print(f"价格: ${ticker['price']:,.0f}")
print(f"涨跌: {ticker['change_percent']:+.2f}%")
print(f"成交量: {ticker['volume']:,.0f} BTC")
```

### 方案C: 从CSV文件读取

```python
import pandas as pd

def load_csv_data(filepath='带信号标记_完整数据_修复版.csv'):
    """
    从CSV文件加载历史数据

    CSV格式:
        时间,收盘价,最高价,最低价,信号类型,...
    """
    df = pd.read_csv(filepath, encoding='utf-8-sig')
    df['时间'] = pd.to_datetime(df['时间'])

    # 确保数值类型正确
    df['收盘价'] = df['收盘价'].astype(float)
    df['成交量'] = df.get('成交量', 1000000).astype(float)

    return df

# 使用示例
df = load_csv_data()
print(df[['时间', '收盘价', '信号类型']].tail())
```

---

## 🔄 完整的数据流

### 实时模式 (实盘交易)

```
1. Binance API
   ↓
2. 获取ticker数据 (价格、成交量)
   ↓
3. 更新价格历史和成交量历史
   ↓
4. 计算EMA、量能比率、加速度
   ↓
5. 计算V8_Score
   ↓
6. 如果V8_Score >= 0.7
   ↓
7. Singularity分类
   ↓
8. 微观结构过滤
   ↓
9. 交易决策
   ↓
10. 开仓/平仓
```

### 历史模式 (回测)

```
1. CSV文件
   ↓
2. 读取历史K线数据
   ↓
3. 逐行计算指标
   ↓
4. 计算V8_Score
   ↓
5. 识别信号
   ↓
6. 模拟开仓/平仓
   ↓
7. 计算回报
```

---

## 📝 修正后的V80Engine类

```python
class V80Engine:
    """V8.0动态策略引擎 - 包含数据获取"""

    def __init__(self, data_source='binance', lookback=20):
        self.data_source = data_source
        self.lookback = lookback

        # 数据缓存
        self.price_history = []
        self.volume_history = []
        self.ema_history = []

    def fetch_data(self):
        """第0层: 数据获取"""

        if self.data_source == 'binance':
            # 方案A: 实时API
            import requests

            try:
                url = "https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT"
                response = requests.get(url, timeout=10)
                data = response.json()

                return {
                    'price': float(data['lastPrice']),
                    'volume': float(data['volume']),
                    'high': float(data['highPrice']),
                    'low': float(data['lowPrice']),
                    'quote_volume': float(data['quoteVolume']),
                    'change_percent': float(data['priceChangePercent']),
                    'timestamp': datetime.now()
                }
            except Exception as e:
                print(f"[ERROR] 获取数据失败: {e}")
                return None

        elif self.data_source == 'csv':
            # 方案B: CSV文件
            # 实际应用中需要实现逐行读取逻辑
            pass

        return None

    def calculate_indicators(self, market_data):
        """第1层: 指标计算"""

        # 更新历史
        self.price_history.append(market_data['price'])
        self.volume_history.append(market_data['volume'])

        # 保持历史长度
        if len(self.price_history) > 100:
            self.price_history.pop(0)
            self.volume_history.pop(0)

        # 1. 计算EMA
        ema = self.calculate_ema(market_data['price'])

        # 2. 计算张力
        tension = (market_data['price'] - ema) / ema if ema > 0 else 0

        # 3. 计算量能比率
        if len(self.volume_history) >= self.lookback:
            avg_volume = np.mean(self.volume_history[-self.lookback:])
        else:
            avg_volume = market_data['volume']

        volume_ratio = market_data['volume'] / avg_volume if avg_volume > 0 else 1.0

        # 4. 计算加速度
        if len(self.price_history) >= 3:
            change1 = (self.price_history[-1] - self.price_history[-2]) / self.price_history[-2]
            change2 = (self.price_history[-2] - self.price_history[-3]) / self.price_history[-3]
            acceleration = change1 - change2
        else:
            acceleration = 0.0

        return {
            'ema': ema,
            'tension': tension,
            'volume_ratio': volume_ratio,
            'acceleration': acceleration
        }

    def calculate_v8_score(self, indicators):
        """第2层: V8.0评分"""

        # EMA突变 (50%)
        delta_ema_abs = abs(indicators['tension'])
        score_ema = min(delta_ema_abs / 0.3, 1.0) * 0.5

        # 量能突变 (30%)
        delta_vol = indicators['volume_ratio'] - 1.0
        score_vol = min(abs(delta_vol) / 0.5, 1.0) * 0.3

        # 基础量能 (20%)
        score_base = min(indicators['volume_ratio'] / 2.0, 1.0) * 0.2

        v8_score = score_ema + score_vol + score_base

        return v8_score

    def process(self):
        """完整流程: 数据获取 → 指标计算 → V8.0评分"""

        # 第0层: 获取数据
        market_data = self.fetch_data()
        if not market_data:
            return None

        # 第1层: 计算指标
        indicators = self.calculate_indicators(market_data)

        # 第2层: 计算V8_Score
        v8_score = self.calculate_v8_score(indicators)

        return {
            'price': market_data['price'],
            'volume': market_data['volume'],
            'ema': indicators['ema'],
            'tension': indicators['tension'],
            'acceleration': indicators['acceleration'],
            'volume_ratio': indicators['volume_ratio'],
            'v8_score': v8_score
        }
```

---

## ✅ 修正总结

### 问题

原流程缺少**数据来源层**，导致不清楚指标从哪里计算。

### 修正

添加了**第0层：数据获取**，明确了三个数据源选项：

1. **Binance API** (实时)
   - K线数据: `/api/v3/klines`
   - 24hr ticker: `/api/v3/ticker/24hr`

2. **CSV文件** (历史)
   - `带信号标记_完整数据_修复版.csv`

3. **WebSocket** (实时流)
   - `wss://stream.binance.com:9443/ws/btcusdt@ticker`

### 完整流程 (7层)

```
第0层: 数据获取 ← Binance API或CSV
   ↓
第1层: 指标计算 ← EMA, 量能比率, 张力, 加速度
   ↓
第2层: V8.0评分 ← V8_Score >= 0.7
   ↓
第3层: Singularity分类
   ↓
第4层: 微观结构过滤
   ↓
第5层: 反向策略决策
   ↓
第6层: 仓位管理
   ↓
第7层: 风险管理
```

---

## 📖 数据获取文档

### Binance API文档

- **K线**: https://binance-docs.github.io/apidocs/spot/cn/#k-
- **Ticker**: https://binance-docs.github.io/apidocs/spot/cn/#24hr

### 限速规则

- **权重限制**: 1200/分钟
- **K线 (1个)**: 权重1
- **24hr ticker (1个)**: 权重1

**建议**: 每5-10秒请求一次，足够满足需求

---

**感谢指正！现在逻辑完整了。** ✅
